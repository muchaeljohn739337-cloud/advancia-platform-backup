name: Backup and Run Migrations

on:
  workflow_dispatch:
  schedule:
    # run nightly at 03:00 UTC; change as desired
    - cron: '0 3 * * *'

jobs:
  backup-and-migrate:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pg client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create DB backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "${DATABASE_URL:-}" ]; then
            echo "DATABASE_URL secret is required to create a backup. Aborting."
            exit 1
          fi
          echo "Creating pg_dump backup..."
          pg_dump "$DATABASE_URL" -F c -b -v -f backup.dump

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: backup.dump

      - name: Optionally upload backup to S3
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' && secrets.S3_BACKUPS_BUCKET != '' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BACKUPS_BUCKET: ${{ secrets.S3_BACKUPS_BUCKET }}
        run: |
          pip install --user awscli
          export PATH="$HOME/.local/bin:$PATH"
          date=$(date -u +%Y-%m-%d_%H-%M-%SZ)
          key="backups/backend/db-backup-$date.dump"
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws configure set default.region ${AWS_REGION:-us-east-1}
          aws s3 cp backup.dump s3://$S3_BACKUPS_BUCKET/$key --acl private
          echo "Uploaded backup to s3://$S3_BACKUPS_BUCKET/$key"
          echo "Backup completed successfully"

      - name: Health check
        run: |
          # Adjust the URL to your production health endpoint
          HEALTH_URL="https://api.advanciapayledger.com/health"
          echo "Checking health: $HEALTH_URL"
          for i in $(seq 1 12); do
            if curl -fsS "$HEALTH_URL"; then
              echo "Health check OK"
              exit 0
            fi
            echo "Health check failed, retrying..."
            sleep 5
          done
          echo "Health check failed after migration." >&2
          exit 4

  notify:
    runs-on: ubuntu-latest
    needs: backup-and-migrate
    if: always()
    steps:
      - name: Determine status
        id: determine
        run: |
          echo "result=${{ needs.backup-and-migrate.result }}" >> $GITHUB_OUTPUT

      - name: Post Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RESULT: ${{ needs.backup-and-migrate.result }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          STATUS=${RESULT}
          if [ "$STATUS" = "success" ]; then
            TEXT="Backup SUCCEEDED for $GITHUB_REPO. Run: $GITHUB_RUN_URL"
          else
            TEXT="Backup FAILED for $GITHUB_REPO. Run: $GITHUB_RUN_URL"
          fi
          PAYLOAD=$(jq -nc --arg t "$TEXT" '{text:$t}')
          curl -s -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" || true
