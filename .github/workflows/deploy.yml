name: Deploy Advvancia

on:
  push:
    branches: ["main"]
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker images
        run: docker-compose build

  deploy-staging:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: build
    concurrency:
      group: advvancia-staging
      cancel-in-progress: true
    environment: staging
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Staging via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_IP_STAGING }}
          username: ${{ secrets.DROPLET_USER_STAGING }}
          key: ${{ secrets.DROPLET_SSH_KEY_STAGING }}
          script: |
            cd -modular-saas-platform
            git pull origin main
            docker-compose up -d --build

  deploy-production:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    needs: build
    concurrency:
      group: advvancia-production
      cancel-in-progress: false # don't cancel prod deploys
    environment: production
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Production via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_IP_PROD }}
          username: ${{ secrets.DROPLET_USER_PROD }}
          key: ${{ secrets.DROPLET_SSH_KEY_PROD }}
          script: |
            cd -modular-saas-platform
            git pull origin main
            docker-compose up -d --build
