name: Deploy Advvancia

on:
  push:
    branches: ["main"]
  release:
    types: [published]

jobs:
  deploy-staging:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    concurrency:
      group: advvancia-staging
      cancel-in-progress: true
    environment: staging
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Staging via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_IP_STAGING }}
          username: ${{ secrets.DROPLET_USER_STAGING }}
          key: ${{ secrets.DROPLET_SSH_KEY_STAGING }}
          script: |
            cd -modular-saas-platform
            git pull origin main
            cd backend
            npm install --production=false
            npx prisma generate
            npx prisma migrate deploy
            pm2 restart advvancia-backend || pm2 start ecosystem.config.js
            pm2 install pm2-logrotate
            pm2 set pm2-logrotate:max_size 10M
            pm2 set pm2-logrotate:retain 7
            pm2 set pm2-logrotate:compress true
            pm2 set pm2-logrotate:rotateInterval '0 0 * * *'

  deploy-production:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    concurrency:
      group: advvancia-production
      cancel-in-progress: false # don't cancel prod deploys
    environment: production
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Production via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_IP_PROD }}
          username: ${{ secrets.DROPLET_USER_PROD }}
          key: ${{ secrets.DROPLET_SSH_KEY_PROD }}
          script: |
            cd -modular-saas-platform
            git pull origin main
            cd backend
            npm install --production=false
            npx prisma generate
            npx prisma migrate deploy
            pm2 restart advvancia-backend || pm2 start ecosystem.config.js
            pm2 install pm2-logrotate
            pm2 set pm2-logrotate:max_size 10M
            pm2 set pm2-logrotate:retain 7
            pm2 set pm2-logrotate:compress true
            pm2 set pm2-logrotate:rotateInterval '0 0 * * *'
