name: Setup Branch Protection

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to protect (main, staging, production, preview)"
        required: true
        default: "main"
        type: choice
        options:
          - main
          - staging
          - production
          - preview
      protection_level:
        description: "Protection level"
        required: true
        default: "standard"
        type: choice
        options:
          - minimal
          - standard
          - strict

jobs:
  setup-protection:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Branch Protection
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_PAT || secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.inputs.branch }}
          LEVEL: ${{ github.event.inputs.protection_level }}
        run: |
          set -e

          echo "ðŸ”’ Setting up branch protection for: $BRANCH"
          echo "ðŸ“Š Protection level: $LEVEL"

          # Check if token has required permissions
          if [ -z "$GH_TOKEN" ]; then
            echo "âŒ Error: GH_ADMIN_PAT secret not found"
            echo "Please create a GitHub Personal Access Token with 'repo' scope"
            echo "and add it as GH_ADMIN_PAT secret in repository settings"
            exit 1
          fi

          # Define protection levels
          case $LEVEL in
            minimal)
              echo "ðŸ“ Applying minimal protection..."
              PAYLOAD='{
                "required_status_checks": null,
                "enforce_admins": false,
                "required_pull_request_reviews": null,
                "restrictions": null,
                "required_linear_history": false,
                "allow_force_pushes": true,
                "allow_deletions": false
              }'
              ;;
            
            standard)
              echo "ðŸ“ Applying standard protection..."
              PAYLOAD='{
                "required_status_checks": {
                  "strict": true,
                  "contexts": ["build", "type-lint", "CI (pnpm checks)"]
                },
                "enforce_admins": false,
                "required_pull_request_reviews": {
                  "dismiss_stale_reviews": true,
                  "require_code_owner_reviews": false,
                  "required_approving_review_count": 1
                },
                "restrictions": null,
                "required_linear_history": false,
                "allow_force_pushes": false,
                "allow_deletions": false,
                "required_conversation_resolution": true
              }'
              ;;
            
            strict)
              echo "ðŸ“ Applying strict protection..."
              PAYLOAD='{
                "required_status_checks": {
                  "strict": true,
                  "contexts": ["build", "type-lint", "CI (pnpm checks)", "backend", "frontend"]
                },
                "enforce_admins": true,
                "required_pull_request_reviews": {
                  "dismiss_stale_reviews": true,
                  "require_code_owner_reviews": true,
                  "required_approving_review_count": 2,
                  "require_last_push_approval": true
                },
                "restrictions": null,
                "required_linear_history": true,
                "allow_force_pushes": false,
                "allow_deletions": false,
                "block_creations": false,
                "required_conversation_resolution": true,
                "lock_branch": false,
                "allow_fork_syncing": true
              }'
              ;;
          esac

          # Apply branch protection
          echo "ðŸš€ Applying protection to branch: $BRANCH"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO/branches/$BRANCH/protection" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Branch protection successfully applied!"
            echo "$BODY" | jq -r '.url // .'
          else
            echo "âŒ Failed to apply branch protection"
            echo "HTTP Status: $HTTP_CODE"
            echo "$BODY" | jq -r '.message // .'
            
            if [ "$HTTP_CODE" -eq 401 ] || [ "$HTTP_CODE" -eq 403 ]; then
              echo ""
              echo "ðŸ’¡ Token may not have sufficient permissions."
              echo "Required permissions:"
              echo "  - repo (Full control of repositories)"
              echo "  - admin:repo_hook (Full control of repository hooks)"
            fi
            
            exit 1
          fi

      - name: Verify Protection
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_PAT || secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.inputs.branch }}
        run: |
          echo "ðŸ” Verifying branch protection settings..."

          curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/branches/$BRANCH/protection" \
            | jq '{
              required_status_checks,
              enforce_admins,
              required_pull_request_reviews,
              required_linear_history,
              allow_force_pushes,
              allow_deletions
            }'

          echo ""
          echo "âœ… Branch protection verification complete!"
          echo "ðŸ“‹ View full settings: https://github.com/$REPO/settings/branches"

      - name: Summary
        run: |
          echo "## ðŸ”’ Branch Protection Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.event.inputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Level:** \`${{ github.event.inputs.protection_level }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Protection rules have been successfully applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Branch Settings â†’](https://github.com/${{ github.repository }}/settings/branches)" >> $GITHUB_STEP_SUMMARY
