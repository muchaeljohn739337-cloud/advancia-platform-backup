name: Security - Scan Sensitive Files

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main, staging, production]
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  scan-secrets:
    name: Scan for Sensitive Files & Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive scan

      - name: Run custom sensitive files scanner
        id: custom-scan
        continue-on-error: true
        run: |
          chmod +x scripts/scan-sensitive-files.sh
          ./scripts/scan-sensitive-files.sh --detailed || echo "issues_found=true" >> $GITHUB_OUTPUT

      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks scan
        id: gitleaks
        continue-on-error: true
        run: |
          echo "üîç Running Gitleaks secret scanner..."
          gitleaks detect \
            --source . \
            --verbose \
            --report-format json \
            --report-path gitleaks-report.json \
            --exit-code 0

          if [ -f gitleaks-report.json ]; then
            FINDINGS=$(jq length gitleaks-report.json)
            echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
            
            if [ "$FINDINGS" -gt 0 ]; then
              echo "‚ö†Ô∏è  Gitleaks found $FINDINGS potential secrets"
              jq -r '.[] | "File: \(.File):\(.StartLine) - \(.Description)"' gitleaks-report.json
            fi
          fi

      - name: Upload Gitleaks report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

      - name: Check for sensitive file patterns
        run: |
          echo "üîç Checking for sensitive file patterns..."

          # Check for .env files
          if git ls-files | grep -E '\.env$|\.env\.(local|production|staging)$' | grep -v '\.env\.example$'; then
            echo "‚ùå ERROR: .env files found in repository!"
            exit 1
          fi

          # Check for key files
          if git ls-files | grep -E '\.(pem|key|p12|pfx)$'; then
            echo "‚ùå ERROR: Key files found in repository!"
            exit 1
          fi

          # Check for database dumps
          if git ls-files | grep -E '\.(sql|dump|backup)$' | grep -v 'schema\.sql$'; then
            echo "‚ùå ERROR: Database dump files found in repository!"
            exit 1
          fi

          echo "‚úÖ No sensitive file patterns detected"

      - name: Check for hardcoded secrets in code
        run: |
          echo "üîç Checking for hardcoded secrets..."

          # AWS Keys
          if git grep -E 'AKIA[0-9A-Z]{16}' -- ':!SECURITY_AUDIT*.md'; then
            echo "‚ùå ERROR: AWS keys found!"
            exit 1
          fi

          # GitHub Tokens
          if git grep -E 'ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36}' -- ':!SECURITY_AUDIT*.md'; then
            echo "‚ùå ERROR: GitHub tokens found!"
            exit 1
          fi

          # Stripe Live Keys
          if git grep -E 'sk_live_[a-zA-Z0-9]{24,}' -- ':!SECURITY_AUDIT*.md' ':!*.md'; then
            echo "‚ùå ERROR: Stripe live keys found!"
            exit 1
          fi

          # Private Keys
          if git grep -E '-----BEGIN.*PRIVATE KEY-----' -- ':!SECURITY_AUDIT*.md'; then
            echo "‚ùå ERROR: Private keys found!"
            exit 1
          fi

          echo "‚úÖ No hardcoded secrets detected"

      - name: Verify .gitignore protection
        run: |
          echo "üîí Verifying .gitignore protection..."

          required_patterns=(
            ".env"
            ".env.local"
            "*.pem"
            "*.key"
            "*.dump"
          )

          missing=0
          for pattern in "${required_patterns[@]}"; do
            if ! grep -qF "$pattern" .gitignore; then
              echo "‚ö†Ô∏è  Missing in .gitignore: $pattern"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo "‚ùå ERROR: $missing patterns missing from .gitignore"
            exit 1
          fi

          echo "‚úÖ .gitignore properly configured"

      - name: Generate security report
        if: always()
        run: |
          echo "# üîí Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.gitleaks.outputs.findings }}" != "" ] && [ "${{ steps.gitleaks.outputs.findings }}" -gt 0 ]; then
            echo "## ‚ö†Ô∏è Findings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Gitleaks found **${{ steps.gitleaks.outputs.findings }}** potential secrets" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Action Required:** Review the Gitleaks report artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚úÖ No Issues Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No sensitive files or secrets detected in the scan." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìö **Resources:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Secret Management Guide](../blob/main/SECRET_MANAGEMENT_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Security Audit Report](../blob/main/SECURITY_AUDIT_2025-11-17.md)" >> $GITHUB_STEP_SUMMARY

      - name: Fail if secrets found
        if: steps.gitleaks.outputs.findings != '' && steps.gitleaks.outputs.findings > 0
        run: |
          echo "‚ùå Security scan failed: Secrets detected!"
          echo ""
          echo "Please review the findings and remove any sensitive data"
          echo "See: SECRET_MANAGEMENT_GUIDE.md for proper secret management"
          exit 1

      - name: Success
        if: steps.gitleaks.outputs.findings == '' || steps.gitleaks.outputs.findings == 0
        run: |
          echo "‚úÖ Security scan passed!"
          echo "No sensitive files or secrets detected"
