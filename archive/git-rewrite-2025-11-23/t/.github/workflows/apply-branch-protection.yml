# Workflow to apply branch protection to `main` via GitHub API.
# Requires a PAT with `repo` + `admin:repo_hook` scopes stored in the repo secret `GH_ADMIN_PAT`.

name: Apply Branch Protection

on:
  workflow_dispatch:
    inputs:
      required_checks:
        description: 'Comma-separated status check names that must pass (e.g. "Render Pre-Deploy,build,test")'
        required: false
        default: "Render Pre-Deploy,build,test"

jobs:
  apply-protection:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare
        env:
          GH_ADMIN_PAT: ${{ secrets.GH_ADMIN_PAT }}
          REPO: ${{ github.repository }}
          CHECKS: ${{ github.event.inputs.required_checks }}
        run: |
          if [ -z "$GH_ADMIN_PAT" ]; then
            echo "GH_ADMIN_PAT secret is required. Create a PAT with repo/admin scopes and add it as GH_ADMIN_PAT."
            exit 1
          fi
          echo "Required checks: $CHECKS"
          # Convert comma-separated input to JSON array
          IFS=',' read -ra ARR <<< "$CHECKS"
          CONTEXTS_JSON="["
          first=true
          for c in "${ARR[@]}"; do
            c_trimmed=$(echo "$c" | awk '{$1=$1;print}')
            if [ "$first" = true ]; then
              CONTEXTS_JSON="$CONTEXTS_JSON\"$c_trimmed\""
              first=false
            else
              CONTEXTS_JSON="$CONTEXTS_JSON,\"$c_trimmed\""
            fi
          done
          CONTEXTS_JSON="$CONTEXTS_JSON]"
          echo "Contexts JSON: $CONTEXTS_JSON"

          # Build protection payload
          read -r -d '' PAYLOAD <<EOF || true
{
  "required_status_checks": {
    "strict": true,
    "contexts": $CONTEXTS_JSON
  },
  "enforce_admins": true,
  "required_pull_request_reviews": null,
  "restrictions": null
}
EOF

          echo "Applying branch protection to: $REPO"
          curl -s -S -X PUT \
            -H "Authorization: token $GH_ADMIN_PAT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/branches/main/protection \
            -d "$PAYLOAD" | jq .

      - name: Show result
        run: echo "Branch protection set (or check output above)."
