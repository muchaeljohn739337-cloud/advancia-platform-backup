name: Render Pre-deploy Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  backend-predeploy:
    name: Backend pre-deploy checks
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgrespw
          POSTGRES_DB: advancia_test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      # Set TEST_DATABASE_URL to the service above
      TEST_DATABASE_URL: postgresql://postgres:postgrespw@127.0.0.1:5432/advancia_test
      # Required secrets - set on GitHub repo settings > Secrets
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      REFRESH_TOKEN_SECRET: ${{ secrets.REFRESH_TOKEN_SECRET }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
      VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies (backend)
        run: |
          cd backend
          npm ci

      - name: Generate Prisma client
        run: |
          cd backend
          npx prisma generate

      - name: Apply database migrations to test DB
        run: |
          cd backend
          export DATABASE_URL="$TEST_DATABASE_URL"
          echo "DATABASE_URL=$DATABASE_URL" # Will be masked by GH actions
          npx prisma migrate deploy

      - name: Backend render:deploy checks (typecheck/build/test)
        run: |
          cd backend
          npm run render:deploy
        env:
          TEST_DATABASE_URL: ${{ env.TEST_DATABASE_URL }}
          JWT_SECRET: ${{ env.JWT_SECRET }}
          REFRESH_TOKEN_SECRET: ${{ env.REFRESH_TOKEN_SECRET }}
          RESEND_API_KEY: ${{ env.RESEND_API_KEY }}
          STRIPE_SECRET_KEY: ${{ env.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ env.STRIPE_WEBHOOK_SECRET }}
          GMAIL_EMAIL: ${{ env.GMAIL_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ env.GMAIL_APP_PASSWORD }}
          VAPID_PUBLIC_KEY: ${{ env.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ env.VAPID_PRIVATE_KEY }}

  frontend-check:
    name: Frontend build & test
    runs-on: ubuntu-latest
    needs: backend-predeploy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Run frontend tests (if any)
        run: |
          cd frontend
          npm test || true
